<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="阳光夜风"><title>NSOperation串行并行理解 · 阳光夜风</title><!-- hexo-inject:begin --><!-- hexo-inject:end --><meta name="description" content="NSOperation是iOS中实现多线程的一个重要模块，在这里整理一些容易忽略或者模糊的点，不会有太多基础的知识。
先大致介绍一些基本知识。
核心的两个类 NSOperation 和 NSOperationQueue概述
NSOperation可以理解为待执行的任务。
NSOperationQue"><meta name="keywords" content="iOS, Apple Foundation, Machine Learning, Algorithm, LeetCode"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">阳光夜风</a></h3><div class="description"><p>上善若水 大盈若冲</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/1685261185"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/categories/">分类</a></li><li><a href="/tags">标签</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"></a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>NSOperation串行并行理解</a></h3></div><div class="post-content"><p>NSOperation是iOS中实现多线程的一个重要模块，在这里整理一些容易忽略或者模糊的点，不会有太多基础的知识。</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>先大致介绍一些基本知识。</p>
<h4 id="核心的两个类-NSOperation-和-NSOperationQueue"><a href="#核心的两个类-NSOperation-和-NSOperationQueue" class="headerlink" title="核心的两个类 NSOperation 和 NSOperationQueue"></a>核心的两个类 NSOperation 和 NSOperationQueue</h4><p><strong>概述</strong></p>
<p>NSOperation可以理解为待执行的任务。</p>
<p>NSOperationQueue是保存任务的队列。</p>
<h4 id="NSOperation"><a href="#NSOperation" class="headerlink" title="NSOperation"></a>NSOperation</h4><p>使用NSOperation一共有三种方式</p>
<ul>
<li>NSBlockOperation（block形式）</li>
<li>NSInvocationOperation（selector形式）</li>
<li>继承NSOperation</li>
</ul>
<p>第一种就是用block的方式实现需要执行的任务；第二种就是使用selector的方式；第三种，由于NSOperation本身是一个基类，内部主要实现operation状态、控制等，没有提供任务接口，所以需要自己继承。</p>
<h4 id="NSOperationQueue"><a href="#NSOperationQueue" class="headerlink" title="NSOperationQueue"></a>NSOperationQueue</h4><p>使用NSOperationQueue一共有两种方式</p>
<ul>
<li>主队列，[NSOperationQueue mainQueue]</li>
<li>其他队列，[[NSOperationQueue alloc] init]</li>
</ul>
<p>第一种队列加入的任务默认是在主线程中执行，由于默认的最大并发数 maxConcurrentOperationCount = 1，所以在主队列中执行的任务只能是串行执行；第二种自行init的队列默认并发数是-1，所以在该种队列中的任务会并发执行。</p>
<hr>
<p>下面到了重点了。（由于方便比较结果，所以下面都统一用 NSBlockOperation 来演示）</p>
<p>NSBlockOperation 中有两个方法来增加任务，一个是默认的构造方法 <code>NSBlockOperation blockOperationWithBlock</code>；另一个是用来增加任务的 <code>addExecutionBlock</code>。那么问题来了，通过<code>addExecutionBlock</code>增加的任务到底是按照什么方式执行的呢？在不同的队列（主队列、其他队列）中会不会有不同呢？多个队列之间的执行又是什么样的呢？</p>
<p>下面就通过几个例子来说明这些问题</p>
<h5 id="1-addExecutionBlock的任务是串行还是并行执行的呢？"><a href="#1-addExecutionBlock的任务是串行还是并行执行的呢？" class="headerlink" title="1. addExecutionBlock的任务是串行还是并行执行的呢？"></a>1. addExecutionBlock的任务是串行还是并行执行的呢？</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">NSBlockOperation *a = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;a------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSOperationQueue *mainQueue = [NSOperationQueue mainQueue];</div><div class="line">[mainQueue addOperation:a];</div></pre></td></tr></table></figure>
<p>输出有多种情况</p>
<p><img src="http://atom-img.oss-cn-beijing.aliyuncs.com/42a342f5c960034fcae9aa5fe049f6c3.png" alt=""></p>
<p><img src="http://atom-img.oss-cn-beijing.aliyuncs.com/9118733abcce10073b1f436ef2933cb1.png" alt=""></p>
<p>可以看出，虽然add在了主队列中，同一个operation中的不同任务（这里可以叫做execution）不一定是串行的。通过<code>addExecutionBlock</code>的execution有可能是在其他线程中执行，也可能是在主线程中执行，但是一定会有一个execution在主线程中执行。</p>
<h5 id="2-mainQueue中的多个operation是怎么执行的？"><a href="#2-mainQueue中的多个operation是怎么执行的？" class="headerlink" title="2. mainQueue中的多个operation是怎么执行的？"></a>2. mainQueue中的多个operation是怎么执行的？</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;------------ab---------------&quot;);</div><div class="line"></div><div class="line">NSBlockOperation *a = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;a------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSBlockOperation *b = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;b------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[b addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;b1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[b addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;b2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSOperationQueue *mainQueue = [NSOperationQueue mainQueue];</div><div class="line">[mainQueue addOperation:a];</div><div class="line">[mainQueue addOperation:b];</div></pre></td></tr></table></figure>
<p><img src="http://atom-img.oss-cn-beijing.aliyuncs.com/1886fa03d1c8c4fa2879494e5888cb8e.png" alt=""></p>
<p>可以看出，主队列中add的不同operation是串行执行的，但是每个operation内部多个不同execution仍然是并行的。</p>
<p>所以通过前两个例子可以充分了解 maxConcurrentOperationCount = 1 时所谓的串行<strong>是指队列中多个operation之间是串行的，但每个operation之间不同的execution仍然是并行的。</strong></p>
<blockquote>
<p><strong><em>由于其他队列都是并发的，情况比较容易理解，所以就不再单独讲其他队列的情况</em></strong></p>
</blockquote>
<h5 id="3-多个队列的执行情况"><a href="#3-多个队列的执行情况" class="headerlink" title="3. 多个队列的执行情况"></a>3. 多个队列的执行情况</h5><p>其实多个队列的执行情况也容易理解，多个队列之间都是不相干的（没有dependency的情况下），所以就是单纯的并发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">NSBlockOperation *a = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;a------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSBlockOperation *b = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;b------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[a addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;a2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSBlockOperation *c = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">    NSLog(@&quot;c------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[b addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;b1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[b addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;b2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[c addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;c1------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[c addExecutionBlock:^&#123;</div><div class="line">    NSLog(@&quot;c2------%@&quot;, [NSThread currentThread]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">NSOperationQueue *queue = [[NSOperationQueue alloc] init];</div><div class="line">NSOperationQueue *mainQueue = [NSOperationQueue mainQueue];</div><div class="line">[queue addOperation:c];</div><div class="line">[queue addOperation:b];</div><div class="line">[mainQueue addOperation:a];</div></pre></td></tr></table></figure>
<p><img src="http://atom-img.oss-cn-beijing.aliyuncs.com/67ad097c2c0fc497b19730679ca50802.png" alt=""><br><img src="http://atom-img.oss-cn-beijing.aliyuncs.com/b53ae62c813f359bea9bca11c1d62975.png" alt=""></p>
<p>可以看到，所有任务之间都是单纯的并发，不会存在不同类型队列之间的依赖关系（就是不会有一定先执行主队列，再执行其他队列的情况。但优先级可能会有不同，这个不确定，多次打log发现大部分情况第一个输出的还是主队列的一个任务）</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-09-16</span><i class="fa fa-comment-o"></i><a href="/posts/NSOperation/#comments">评论</a><i class="fa fa-tag"></i><a class="tag" href="/categories/iOS/" title="iOS">iOS </a><a class="tag" href="/tags/iOS/" title="iOS">iOS </a><a class="tag" href="/tags/多线程/" title="多线程">多线程 </a><a class="tag" href="/tags/NSOperation/" title="NSOperation">NSOperation </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://yhvh009.github.io/posts/NSOperation/,阳光夜风,NSOperation串行并行理解,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/posts/线程与队列/" title="GCD 线程与队列">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/57-Insert-Interval/" title="LeetCode &quot;57. Insert Interval&quot;">下一篇</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'yhvh009-github-io';
var disqus_identifier = 'posts/NSOperation/';
var disqus_title = 'NSOperation串行并行理解';
var disqus_url = 'https://yhvh009.github.io/posts/NSOperation/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>